language: cpp

dist: bionic
sudo: true

branches:
  only:
    - master

arch:
  - amd64
  - ppc64le
  - s390x
  - arm64

matrix:
  include:
  # Linux clang builds
  - os: linux
    compiler: clang
    env:
      - COMPILER=clang++-4.0
      - COV_TOOL=llvm-cov-4.0
      - COV_TOOL_ARGS=gcov
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-bionic-4.0']
        packages: [ 'apport', 'cmake', 'clang-4.0', 'llvm-4.0-tools', 'libstdc++-6-dev', 'libssl-dev', 'libcurl4-openssl-dev', 'gdb', 'lcov', 'cppcheck' ]

  - os: linux
    compiler: clang
    env:
      - COMPILER=clang++-5.0
      - COV_TOOL=llvm-cov-5.0
      - COV_TOOL_ARGS=gcov
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-bionic-5.0']
        packages: [ 'apport', 'cmake', 'clang-5.0', 'llvm-5.0-tools', 'libstdc++-6-dev', 'libssl-dev', 'libcurl4-openssl-dev', 'gdb', 'lcov', 'cppcheck' ]

  - os: linux
    compiler: clang
    env:
      - COMPILER=clang++-6.0
      - COV_TOOL=llvm-cov-6.0
      - COV_TOOL_ARGS=gcov
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-bionic-6.0']
        packages: [ 'apport', 'cmake', 'clang-6.0', 'llvm-6.0-tools', 'libstdc++-6-dev', 'libssl-dev', 'libcurl4-openssl-dev', 'gdb', 'lcov', 'cppcheck' ]

  # Linux GCC builds
  - os: linux
    compiler: gcc
    env:
      - COMPILER=g++-7
      - COV_TOOL=gcov-7
      - COV_TOOL_ARGS=
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test']
        packages: ['apport', 'g++-7', 'libssl-dev', 'libcurl4-openssl-dev', 'gdb', 'lcov', 'cppcheck']

  - os: linux
    compiler: gcc
    env:
      - COMPILER=g++-8
      - COV_TOOL=gcov-8
      - COV_TOOL_ARGS=
    addons:
      apt:
        sources: ['ubuntu-toolchain-r-test']
        packages: ['apport', 'g++-8', 'libssl-dev', 'libcurl4-openssl-dev', 'gdb', 'lcov', 'cppcheck']

install:
  - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
  - mkdir -p ${DEPS_DIR} && cd ${DEPS_DIR}

before_script:
  - export CXX=${COMPILER}
  - cd ${TRAVIS_BUILD_DIR}

  # Enable core dumps
  - ulimit -c
  - ulimit -a -S
  - ulimit -a -H
    # Make sure that crash reports are generated for all executables.
  - mkdir -p ~/.config/apport
  - printf '[main]\nunpackaged=true\n' >> ~/.config/apport/settings

  # Print debug system information
  - cat /proc/sys/kernel/core_pattern
  - cat /etc/default/apport || true
  - service --status-all || true
  - initctl list || true

  # Debug build
  - cmake -H.
    -BBuild-Debug
    -DCMAKE_BUILD_TYPE=Debug
    -DPISTACHE_BUILD_EXAMPLES=true
    -DPISTACHE_BUILD_TESTS=true
    -DPISTACHE_USE_SSL=true

  # Debug build, no SSL
  - cmake -H.
    -BBuild-Debug-nossl
    -DCMAKE_BUILD_TYPE=Debug
    -DPISTACHE_BUILD_EXAMPLES=true
    -DPISTACHE_BUILD_TESTS=true
    -DPISTACHE_USE_SSL=false

  # Release build
  - cmake -H.
    -BBuild-Release
    -DCMAKE_BUILD_TYPE=Release
    -DPISTACHE_USE_SSL=true

script:
  # Set the ulimit
  - ulimit -c unlimited -S

  # Debug build
  - cd Build-Debug
  - make -j 2 all test ARGS="-V"

  # Debug build, no SSL
  - cd ../Build-Debug-nossl
  - make -j 2 all test ARGS="-V"

  # Release build
  - cd ../Build-Release
  - make -j 2

after_failure:
  - CRASHFILES=$(find /var/crash/ -mindepth 1 -maxdepth 1 -print)
  - echo "$CRASHFILES"
    # Unpack the apport crash file into a temporary directory and get the
    # executable and core dump to pass to GDB.
    # Call gdb with the absolute path since it isn't on the PATH.
  - |
    if [ -n "$CRASHFILES" ]; then echo "$CRASHFILES" | while IFS= read -r CRASH; do echo "Crash report: $CRASH"; DIR="/tmp/$(basename $CRASH).d"; apport-unpack "$CRASH" "$DIR"; EXE=$(cat $DIR/ExecutablePath); CORE="$DIR/CoreDump"; echo "Coredump $CORE for $EXE"; /usr/bin/gdb $EXE $CORE -ex "thread apply all bt" -ex "set pagination 0" -batch; done; fi

after_success:
- cd ../Build-Debug
- sudo su -c "echo 'if [ \"\$1\" = \"-v\" ] ; then $COV_TOOL --version ; else $COV_TOOL $COV_TOOL_ARGS \$@ ; fi' > /usr/local/bin/cov-tool" && sudo chmod +x /usr/local/bin/cov-tool
- lcov --capture --gcov-tool cov-tool --directory . --output-file coverage.info
- lcov --remove coverage.info '/usr/*' '*tests/*' '*third-party/*' --output-file coverage.info
- lcov --list coverage.info
- bash <(curl -s https://codecov.io/bash) -f coverage.info || echo "Codecov did not collect coverage reports"
